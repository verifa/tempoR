---
title: "tempo"
author: "bosse"
date: "8/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## tempo

This is an R Markdown document. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button to generate the document.

```{r functions, echo = FALSE}
check.if.empty <- function(var, name) {
  if (var == "") {
    stop.message <- paste(name, "is not defined")
    stop(stop.message)
  }
}

check.packages <- function(package.list) {
  for (package in package.list) {
    tryCatch(find.package(package),
      error = function(e) {
        print(paste("Please install", package, "for this to work"))
      }
    )
  }  
}
```

### Environment variables

For this to work, these needs to be set in **$HOME/.Renviron**

```{r environment, echo = TRUE}
TEMPO_KEY <- Sys.getenv("TEMPO_KEY")
check.if.empty(TEMPO_KEY, "TEMPO_KEY")
TEMPO_START <- Sys.getenv("TEMPO_START")
check.if.empty(TEMPO_START, "TEMPO_START")
WD_KEY <- Sys.getenv("ARBETSDAGAR_KEY")
check.if.empty(WD_KEY, "WD_KEY")
```

where TEMPO_KEY is the api key and TEMPO_START is the date you started using tempo. WD_KEY is the api key for "arbetsdagar.se", you will have to register, at least, a free account to use the service.

```{r libraries, echo = FALSE, warning = FALSE, message = FALSE}

packages <- c("tidyverse", "jsonlite", "httr", "stringr", "slider", "lubridate")
check.packages(packages)

library(tidyverse)
library(dplyr)
library(httr)
library(jsonlite)
library(stringr)
library(slider)
library(lubridate)
```

```{r fetch-data, echo = FALSE, message = FALSE}
offset <- 0
count <- 100
TEMPO_LIMIT <- count

while (count == TEMPO_LIMIT) {
  TEMPO_QUERY <- paste0("worklogs?from=", TEMPO_START, "&to=", Sys.Date(), "&offset=", offset, "&limit=", TEMPO_LIMIT)
  TEMPO_URL <- "https://api.tempo.io/core/3/"
  url <- paste0(TEMPO_URL, TEMPO_QUERY)
  header <- paste0("Bearer ", TEMPO_KEY)
  message(url)
  httpResponse <- GET(url, add_headers("Authorization" = header), accept_json(), timeout(20))
  
  results <- fromJSON(content(httpResponse, "text"))
  
  count <- results$metadata$count
  if (offset == 0) {
    tempo.data <- results$results
  } else {
    tempo.data <- bind_rows(tempo.data, results$results)
    
  }
  offset <- offset + TEMPO_LIMIT
}


workingdays <- function(begins, ends) {
  result <- c()
  for (i in seq(length.out=length(begins))) {
    # working days
    WD_URL = "http://api.arbetsdag.se/v2/dagar.json"
    WD_QUERY = paste0("?fran=", as.Date(begins[i]), "&till=", as.Date(ends[i]), "&key=", WD_KEY, "&id=1234")
    url = paste0(WD_URL, WD_QUERY)
    
    WD <- fromJSON(url)
    result[i] <- WD$antal_vardagar
  }
  return(result)
}
```

```{r aggregate-data, echo = FALSE, warning = FALSE, message = FALSE}

aggregated.data <- tempo.data %>%
  mutate(
    user = author$displayName,
    hours = timeSpentSeconds/(60*60),
    billable = billableSeconds/(60*60),
    date = as.Date(startDate),
    key = str_replace(issue$key, "-.*", ""),
    issue.key = issue$key
  )

# str(aggregated.data)

user.data <- aggregated.data %>%
  group_by(date, user, key) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  )

# detailed.data <- tempo.data %>%
#   mutate(
#     user = author$displayName,
#     hours = timeSpentSeconds/(60*60),
#     billable = billableSeconds/(60*60),
#     date = as.Date(startDate),
#     key = issue$key
#   )
# 
# billable.data <- subset(detailed.data, billable > 0)
# unbillable.data <- subset(detailed.data, billable == 0)

# str(detailed.data)

user.detail <- aggregated.data %>%
  group_by(user, issue.key) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  )

user.summary <- aggregated.data %>%
  group_by(date, user) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  ) %>%
  group_by(user) %>%
  mutate(
    cumulative.hours = cumsum(hours),
    cumulative.billable = cumsum(billable),
    roll.7.hours = slide_index_dbl(hours, date, sum, .before = days(6), .complete = TRUE),
    roll.7.billable = slide_index_dbl(billable, date, sum, .before = days(6), .complete = TRUE),
    roll.30.hours = slide_index_dbl(roll.7.hours, date, mean, .before = days(29), .complete = TRUE),
    roll.30.billable = slide_index_dbl(roll.7.billable, date, mean, .before = days(29), .complete = TRUE)
  )

#str(user.summary)

team.summary <- user.summary %>%
  group_by(date) %>%
  summarise(
    average.7.hours = mean(roll.7.hours, na.rm = TRUE),
    sd.7.hours = sd(roll.7.hours, na.rm = TRUE),
    average.30.hours = mean(roll.30.hours, na.rm = TRUE),
    sd.30.hours = sd(roll.30.hours, na.rm = TRUE),
    average.7.billable = mean(roll.7.billable, na.rm = TRUE),
    sd.7.billable = sd(roll.7.billable, na.rm = TRUE),
    average.30.billable = mean(roll.30.billable, na.rm = TRUE),
    sd.30.billable = sd(roll.30.billable, na.rm = TRUE)
  )
# str(team.summary)

user.delta <- aggregated.data %>%
  group_by(user) %>%
  summarise(
    start = min(startDate),
    end = max(startDate),
    expected = 8 * workingdays(start, end), 
    hours = sum(hours),
    delta = hours - expected,
    billable = sum(billable),
    fraction = 100 * billable / expected
  )

# str(user.delta)

```


```{r tempo, echo = FALSE, warning = FALSE, message = FALSE}
tempo <- ggplot(data = aggregated.data) +
  geom_col(aes(x = date, y = hours, fill = key)) +
  facet_wrap(~user) + scale_fill_hue(l = 45) + 
  scale_y_continuous(
    breaks = c(0,2,4,6,8,10), 
    name = "Daily",
    sec.axis = dup_axis()) +
  scale_x_date(name = NULL) +
  theme(legend.position = "top") +
  ggtitle("Daily logs")

tempo.detailed <- ggplot(data = aggregated.data) +
  geom_col(aes(x = date, y = hours, fill = issue.key)) +
  facet_wrap(~user) + scale_fill_hue(l = 45) + 
  scale_y_continuous(
    breaks = c(0,2,4,6,8,10), 
    name = "Daily",
    sec.axis = dup_axis()) +
  scale_x_date(name = NULL) +
  theme(legend.position = "top") +
  coord_cartesian(xlim = c(Sys.Date() - 14, Sys.Date())) +
  ggtitle("Detailed logs, last 14 days")

tempo.billable <- ggplot(data = subset(user.detail, billable > 0)) +
  geom_point(aes(x = reorder(issue.key, -hours), 
                 y = hours, 
                 color = issue.key, 
                 fill = issue.key,
                 size = sqrt(hours))) +
  facet_wrap(~user) + scale_fill_hue(l = 45) + 
  scale_y_continuous(
    sec.axis = dup_axis()) +
  theme(legend.position = "top") +
  ggtitle("Billable tasks")

#   geom_col(aes(x = reorder(issue.key, -hours), y = hours, fill = issue.key)) +

tempo.unbillable <- ggplot(data = subset(user.detail, billable == 0)) +
  geom_col(aes(x = reorder(issue.key, -hours), y = hours, fill = issue.key)) +
  facet_wrap(~user) + scale_fill_hue(l = 45) + 
  scale_y_continuous(
    sec.axis = dup_axis()) +
  theme(legend.position = "top") +
  ggtitle("Unbillable tasks")
```

```{r team, echo = FALSE, warning = FALSE, message = FALSE}
team <- ggplot(data = team.summary) +
  geom_point(aes(x = date, y = average.7.hours), color = "Gray50", shape = 1) + 
  geom_point(aes(x = date, y = average.30.hours), color = "Dark Blue") + 
  geom_smooth(aes(x = date, y = average.30.hours), color = "Dark Blue") +
  geom_point(aes(x = date, y = average.7.billable), color = "Gray75", shape = 1) + 
  geom_point(aes(x = date, y = average.30.billable), color = "Dark Green") + 
  geom_smooth(aes(x = date, y = average.30.billable), color = "Dark Green") +
  scale_color_hue(l = 45) + scale_fill_hue(l = 45) +
  scale_y_continuous(
    breaks = c(0,8,16,24,32,40, 48,56), 
    name = "Weekly", 
    sec.axis = sec_axis(~ . * 2.5, 
                        breaks = c(0, 20, 40, 60, 80, 100), 
                        name = "Rolling Fraction [%] ")) +
  scale_x_date(name = NULL) +
  theme(legend.position = "top", legend.title = element_blank())

```

```{r rolling, echo = FALSE, warning = FALSE, message = FALSE}
rolling <- ggplot(data = user.summary) +
  geom_point(aes(x = date, y = roll.7.hours), color = "Gray50", shape = 1) + 
  geom_point(aes(x = date, y = roll.7.billable), color = "Gray75", shape = 1) + 
  geom_point(aes(x = date, y = roll.30.hours), color = "Dark Blue") + 
  geom_line(aes(x = date, y = roll.30.hours), color = "Dark Blue") + 
  geom_point(aes(x = date, y = roll.30.billable), color = "Dark Green") + 
  geom_line(aes(x = date, y = roll.30.billable), color = "Dark Green") + 
  facet_wrap(~user) + scale_fill_hue(l = 45) + scale_color_hue(l = 45) +
  scale_y_continuous(
    breaks = c(0,8,16,24,32,40, 48), 
    name = "Rolling Weekly [h]", 
    sec.axis = sec_axis(~ . * 2.5, 
                        breaks = c(0, 20, 40, 60, 80, 100), 
                        name = "Rolling Fraction [%] ")) +
  scale_x_date(name = NULL) +
  theme(legend.position = "top", legend.title = element_blank())
```

```{r accumulated, echo = FALSE, warning = FALSE, message = FALSE}
accumulated <- ggplot(data = user.delta) +
  geom_col(aes(x = user, y = delta, fill = user), show.legend = FALSE) +
  scale_fill_hue(l = 45) +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(
    name = "Delta hours [h]",
    sec.axis = dup_axis())
```

```{r plot, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(user.delta, caption = "User summary")

plot(accumulated)

plot(team)

plot(rolling)

plot(tempo)

plot(tempo.detailed)

plot(tempo.billable)

plot(tempo.unbillable)

```
