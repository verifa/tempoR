---
title: "tempo"
author: "bosse"
date: "8/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## tempo

This is an R Markdown document. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button to generate the document.

```{r functions, echo = TRUE}
check.if.empty <- function(var, name) {
  if (var == "") {
    stop.message <- paste(name, "is not defined")
    stop(stop.message)
  }
}

check.packages <- function(package.list) {
  for (package in package.list) {
    tryCatch(find.package(package),
      error = function(e) {
        print(paste("Please install", package, "for this to work"))
      }
    )
  }  
}
```

### Environment variables

For this to work, these needs to be set in **$HOME/.Renviron**

```{r environment, echo = TRUE}
TEMPO_KEY <- Sys.getenv("TEMPO_KEY")
check.if.empty(TEMPO_KEY, "TEMPO_KEY")
TEMPO_START <- Sys.getenv("TEMPO_START")
check.if.empty(TEMPO_START, "TEMPO_START")
```

where TEMPO_KEY is the api key and TEMPO_START is the date you started using tempo

```{r libraries, echo = FALSE}

packages <- c("tidyverse", "jsonlite", "httr", "stringr")
check.packages(packages)

library(tidyverse)
library(httr)
library(jsonlite)
library(stringr)
```

```{r fetch-data, echo = FALSE}
TEMPO_QUERY = paste0("worklogs?from=", TEMPO_START, "&to=", Sys.Date())
TEMPO_URL = "https://api.tempo.io/core/3/"
url = paste0(TEMPO_URL, TEMPO_QUERY)
header = paste0("Bearer ", TEMPO_KEY)
httpResponse <- GET(url, add_headers("Authorization" = header), accept_json())

results = fromJSON(content(httpResponse, "text"))
```

```{r aggregate-data, echo = FALSE}
tempo.data <- results$results

tempo.data <- tempo.data %>%
  mutate(
    user = author$displayName,
    hours = timeSpentSeconds/(60*60),
    billable = billableSeconds/(60*60),
    date = as.Date(startDate),
    key = str_replace(issue$key, "-.*", "")
  )

# str(tempo.data)

user.data <- tempo.data %>%
  group_by(date, user, key) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  )

test <- tempo.data %>%
  group_by(date, user) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  ) 

# mutate do not work..... so workaround
user.summary <- bind_cols(test$date, 
                          test$user, 
                          cumsum(test$hours),
                          cumsum(test$billable))
colnames(user.summary) <- c("date", "user", "hours", "billable")

# str(test)

```

```{r tempo, echo = FALSE}
tempo <- ggplot(data = user.data) +
  geom_col(aes(x = date, y = hours, fill = key)) +
  facet_wrap(~user) + scale_fill_hue(l = 45)
```

```{r accumulated, echo = FALSE}
accumulated <- ggplot(data = user.summary) +
  geom_step(aes(x = date, y = hours), color = "Blue") +
  geom_point(aes(x = date, y = hours), color = "Blue") +
  geom_step(aes(x = date, y = billable), color = "Dark Green") +
  facet_wrap(~user) + scale_color_hue(l = 45)
```

```{r plot, echo = FALSE}
plot(tempo)

plot(accumulated)
```