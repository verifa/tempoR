---
title: "tempo"
author: "bosse"
date: "8/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## tempo

This is an R Markdown document. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button to generate the document.

```{r functions, echo = FALSE}
check.if.empty <- function(var, name) {
  if (var == "") {
    stop.message <- paste(name, "is not defined")
    stop(stop.message)
  }
}

check.packages <- function(package.list) {
  for (package in package.list) {
    tryCatch(find.package(package),
      error = function(e) {
        print(paste("Please install", package, "for this to work"))
      }
    )
  }  
}
```

### Environment variables

For this to work, these needs to be set in **$HOME/.Renviron**

```{r environment, echo = TRUE}
TEMPO_KEY <- Sys.getenv("TEMPO_KEY")
check.if.empty(TEMPO_KEY, "TEMPO_KEY")
TEMPO_START <- Sys.getenv("TEMPO_START")
check.if.empty(TEMPO_START, "TEMPO_START")
```

where TEMPO_KEY is the api key and TEMPO_START is the date you started using tempo

```{r libraries, echo = FALSE, warning = FALSE, message = FALSE}

packages <- c("tidyverse", "jsonlite", "httr", "stringr", "slider", "lubridate")
check.packages(packages)

library(tidyverse)
library(httr)
library(jsonlite)
library(stringr)
library(slider)
library(lubridate)
```

```{r fetch-data, echo = FALSE, message = FALSE}
TEMPO_QUERY = paste0("worklogs?from=", TEMPO_START, "&to=", Sys.Date())
TEMPO_URL = "https://api.tempo.io/core/3/"
url = paste0(TEMPO_URL, TEMPO_QUERY)
header = paste0("Bearer ", TEMPO_KEY)
httpResponse <- GET(url, add_headers("Authorization" = header), accept_json(), timeout(20))

results = fromJSON(content(httpResponse, "text"))

TEMPO_END <- max(results$results$startDate)

# working days
WD_URL = "http://api.arbetsdag.se/v1/dagar.json"
WD_KEY = "36995a30eb42c258b39ed90907281f2d4e4b5be5"
WD_QUERY = paste0("?fran=", TEMPO_START, "&till=", TEMPO_END, "&key=", WD_KEY, "&id=1234")
url = paste0(WD_URL, WD_QUERY)

WD <- fromJSON(url)

#str(WD)
```

```{r aggregate-data, echo = FALSE, message = FALSE}
tempo.data <- results$results

tempo.data <- tempo.data %>%
  mutate(
    user = author$displayName,
    hours = timeSpentSeconds/(60*60),
    billable = billableSeconds/(60*60),
    date = as.Date(startDate),
    key = str_replace(issue$key, "-.*", "")
  )

# str(tempo.data)

user.data <- tempo.data %>%
  group_by(date, user, key) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  )

user.summary <- tempo.data %>%
  group_by(date, user) %>%
  summarise(
    hours = sum(hours),
    billable = sum(billable)
  ) %>%
  group_by(user) %>%
  mutate(
    cumulative.hours = cumsum(hours),
    cumulative.billable = cumsum(billable),
    roll.7.hours = slide_index_dbl(hours, date, sum, .before = days(6)),
    roll.7.billable = slide_index_dbl(billable, date, sum, .before = days(6))
  )

str(user.summary)

```

```{r tempo, echo = FALSE}
tempo <- ggplot(data = user.data) +
  geom_col(aes(x = date, y = hours, fill = key)) +
  geom_point(data = user.summary, aes(x = date, y = roll.7.hours/5), color = "Gray25") + 
  geom_smooth(data = user.summary, aes(x = date, y = roll.7.hours/5), color = "Gray25") + 
  geom_point(data = user.summary, aes(x = date, y = roll.7.billable/5), color = "Gray50") + 
  geom_smooth(data = user.summary, aes(x = date, y = roll.7.billable/5), color = "Gray50") + 
  facet_wrap(~user) + scale_fill_hue(l = 45) + 
  scale_y_continuous(breaks = c(0,2,4,6,8,10), name = "Daily", 
                     sec.axis = sec_axis(~ . * 5, name = "Weekly")) +
  theme(legend.position = "top", legend.title = element_blank())
```

```{r accumulated, echo = FALSE}
target <- WD$antal_arbetsdagar * 8
delta <- max(user.summary$cumulative.hours) - target


accumulated <- ggplot(data = user.summary) +
  annotate("segment", 
           x = as.Date(TEMPO_START), 
           xend = as.Date(TEMPO_END), 
           y = 0, 
           yend = target, 
           colour = "dark grey") +
  annotate("text", 
           x = as.Date(TEMPO_START) + 5, 
           y = target * 0.75, 
           label = paste("Delta:", delta), 
           color = "Gray25") +
  geom_point(aes(x = date, y = cumulative.hours), color = "Gray25") +
  geom_smooth(aes(x = date, y = cumulative.hours), color = "Gray25") +
  geom_point(aes(x = date, y = cumulative.billable), color = "Gray50") +
  geom_smooth(aes(x = date, y = cumulative.billable), color = "Gray50") +
  facet_wrap(~user) + scale_color_hue(l = 45)
```

```{r plot, echo = FALSE}
plot(tempo)

plot(accumulated)
```
